## قائمة المهام التفصيلية: تنفيذ توسيع EchoOps Real Estate CRM وتطبيق الصلاحيات

### المرحلة 1: إعداد بيئة التطوير وتحديث التبعيات

-   [ ] **الواجهة الخلفية (Backend - NestJS)**:
    -   [ ] تحديث جميع حزم npm إلى أحدث الإصدارات المستقرة.
    -   [ ] التأكد من توافق NestJS و TypeORM مع التغييرات القادمة.
    -   [ ] مراجعة ملفات التكوين (config files) للتأكد من جاهزيتها للتغييرات.
-   [ ] **الواجهة الأمامية (Frontend - React)**:
    -   [ ] تحديث جميع حزم npm إلى أحدث الإصدارات المستقرة.
    -   [ ] مراجعة ملفات التكوين (config files) للتأكد من جاهزيتها.
-   [ ] **قاعدة البيانات (MySQL)**:
    -   [ ] التأكد من وجود بيئة تطوير لقاعدة البيانات.
    -   [ ] إعداد أداة لإدارة الهجرات (Migrations) إذا لم تكن موجودة (مثل TypeORM Migrations).

### المرحلة 2: تنفيذ كيان المطور (Developer)

-   [ ] **الواجهة الخلفية (Backend)**:
    -   [ ] **إنشاء Entity (نموذج قاعدة البيانات)**: إنشاء ملف `developer.entity.ts` في `backend/src/developers/entities/`.
        -   [ ] تعريف الحقول: `id`, `name` (اسم المطور), `description`, `contactInfo`, `logoUrl`, `websiteUrl`, `createdAt`, `updatedAt`.
        -   [ ] إضافة حقل `companyId` لربط المطور بالشركة المستأجرة (Multi-tenant).
    -   [ ] **إنشاء Module**: إنشاء `developers.module.ts` في `backend/src/developers/`.
    -   [ ] **إنشاء Service**: إنشاء `developers.service.ts` للتعامل مع منطق الأعمال والوصول إلى قاعدة البيانات.
        -   [ ] تنفيذ عمليات CRUD الأساسية (Create, Read, Update, Delete).
        -   [ ] تطبيق تصفية `companyId` في جميع استعلامات القراءة والتعديل والحذف لضمان عزل البيانات.
    -   [ ] **إنشاء Controller**: إنشاء `developers.controller.ts` لتعريف مسارات API.
        -   [ ] تعريف مسارات `POST /developers`, `GET /developers`, `GET /developers/:id`, `PUT /developers/:id`, `DELETE /developers/:id`.
        -   [ ] تطبيق `PermissionsGuard` على جميع المسارات (مثال: `@Permissions("developers.create")`).
    -   [ ] **تحديث App Module**: استيراد `DevelopersModule` في `app.module.ts`.
    -   [ ] **إنشاء Migration**: إنشاء ملف هجرة لقاعدة البيانات لإضافة جدول `developers`.
-   [ ] **الواجهة الأمامية (Frontend)**:
    -   [ ] **إنشاء صفحة قائمة المطورين**: `frontend/src/pages/Developers.tsx`.
        -   [ ] عرض جدول أو قائمة بالمطورين مع إمكانية البحث والتصفية والفرز.
        -   [ ] دمج API `GET /developers`.
        -   [ ] إخفاء/تعطيل أزرار `Add`, `Edit`, `Delete` بناءً على صلاحيات المستخدم (`developers.create`, `developers.update`, `developers.delete`).
    -   [ ] **إنشاء مكون نموذج المطور**: لإنشاء/تعديل المطورين.
        -   [ ] استخدام `Dialog` أو `Drawer` لعرض النموذج.
        -   [ ] دمج API `POST /developers` و `PUT /developers/:id`.
        -   [ ] تطبيق صلاحيات الحقول (مثال: حقل `logoUrl` قد يكون متاحًا فقط لـ `Company Admin`).
    -   [ ] **تحديث الملاحة (Navigation)**: إضافة رابط لصفحة المطورين في الشريط الجانبي (Sidebar) أو القائمة الرئيسية.

### المرحلة 3: تنفيذ كيان المشروع (Project)

-   [ ] **الواجهة الخلفية (Backend)**:
    -   [ ] **إنشاء Entity**: إنشاء ملف `project.entity.ts` في `backend/src/projects/entities/`.
        -   [ ] تعريف الحقول: `id`, `name` (اسم المشروع), `description`, `location`, `startDate`, `endDate`, `status`, `imageUrl`, `createdAt`, `updatedAt`.
        -   [ ] **إضافة علاقة مع المطور**: إضافة حقل `developerId` (Many-to-One) لربط المشروع بالمطور.
        -   [ ] إضافة حقل `companyId` لربط المشروع بالشركة المستأجرة.
    -   [ ] **إنشاء Module**: إنشاء `projects.module.ts`.
    -   [ ] **إنشاء Service**: إنشاء `projects.service.ts`.
        -   [ ] تنفيذ عمليات CRUD الأساسية.
        -   [ ] تطبيق تصفية `companyId` في جميع الاستعلامات.
        -   [ ] التأكد من أن المستخدم لا يمكنه ربط مشروع بمطور لا ينتمي إلى شركته.
    -   [ ] **إنشاء Controller**: إنشاء `projects.controller.ts`.
        -   [ ] تعريف مسارات `POST /projects`, `GET /projects`, `GET /projects/:id`, `PUT /projects/:id`, `DELETE /projects/:id`.
        -   [ ] تطبيق `PermissionsGuard` على جميع المسارات (مثال: `@Permissions("projects.create")`).
    -   [ ] **تحديث App Module**: استيراد `ProjectsModule`.
    -   [ ] **إنشاء Migration**: إنشاء ملف هجرة لقاعدة البيانات لإضافة جدول `projects` مع المفتاح الخارجي لـ `developers`.
-   [ ] **الواجهة الأمامية (Frontend)**:
    -   [ ] **إنشاء صفحة قائمة المشاريع**: `frontend/src/pages/Projects.tsx`.
        -   [ ] عرض جدول أو قائمة بالمشاريع مع إمكانية البحث والتصفية (حسب المطور) والفرز.
        -   [ ] دمج API `GET /projects`.
        -   [ ] إخفاء/تعطيل أزرار `Add`, `Edit`, `Delete` بناءً على صلاحيات المستخدم.
    -   [ ] **إنشاء مكون نموذج المشروع**: لإنشاء/تعديل المشاريع.
        -   [ ] إضافة حقل اختيار المطور (Dropdown) الذي يتم جلب بياناته من API المطورين.
        -   [ ] دمج API `POST /projects` و `PUT /projects/:id`.
    -   [ ] **تحديث الملاحة**: إضافة رابط لصفحة المشاريع.

### المرحلة 4: تعديل كيان الوحدة العقارية (Property/Unit)

-   [ ] **الواجهة الخلفية (Backend)**:
    -   [ ] **تعديل Entity**: تعديل `property.entity.ts` (أو إعادة تسميته إلى `unit.entity.ts`).
        -   [ ] **إضافة علاقة مع المشروع**: إضافة حقل `projectId` (Many-to-One) لربط الوحدة بالمشروع.
        -   [ ] التأكد من أن الوحدة لا يمكن ربطها بمشروع لا ينتمي إلى نفس الشركة.
    -   [ ] **تعديل Service**: تعديل `properties.service.ts`.
        -   [ ] تحديث عمليات CRUD لتشمل `projectId`.
        -   [ ] تحديث منطق البحث والتصفية ليشمل البحث حسب `projectId` أو `developerId` (عبر `projectId`).
    -   [ ] **تعديل Controller**: تعديل `properties.controller.ts`.
        -   [ ] تحديث مسارات API لتشمل `projectId` في عمليات الإنشاء والتحديث.
        -   [ ] تحديث `PermissionsGuard` ليشمل صلاحيات خاصة بالوحدات (مثال: `units.create`, `units.read`).
    -   [ ] **إنشاء Migration**: إنشاء ملف هجرة لتعديل جدول `properties` وإضافة المفتاح الخارجي لـ `projects`.
-   [ ] **الواجهة الأمامية (Frontend)**:
    -   [ ] **تعديل صفحة إدارة الوحدات**: `frontend/src/pages/Properties.tsx`.
        -   [ ] إعادة تسمية الصفحة والمكونات ذات الصلة من `Property` إلى `Unit` (اختياري ولكن موصى به للوضوح).
        -   [ ] إضافة حقل اختيار المشروع (Dropdown) في نموذج إنشاء/تعديل الوحدة.
        -   [ ] تحديث فلاتر البحث لتشمل البحث حسب المشروع والمطور.
        -   [ ] عرض معلومات المشروع والمطور في قائمة وتفاصيل الوحدة.
        -   [ ] تحديث صلاحيات الأزرار والحقول بناءً على صلاحيات `units.create`, `units.update`, `units.delete`.

### المرحلة 5: تعديل كيانات العملاء المحتملين والصفقات (Leads & Deals)

-   [ ] **الواجهة الخلفية (Backend)**:
    -   [ ] **تعديل Entities**: تعديل `lead.entity.ts` و `deal.entity.ts`.
        -   [ ] إضافة حقل `unitId` (Many-to-One) لربط العميل المحتمل/الصفقة بوحدة عقارية.
        -   [ ] التأكد من أن العميل المحتمل/الصفقة لا يمكن ربطها بوحدة لا تنتمي إلى نفس الشركة.
    -   [ ] **تعديل Services**: تحديث `leads.service.ts` و `deals.service.ts`.
        -   [ ] تحديث عمليات CRUD لتشمل `unitId`.
        -   [ ] تحديث منطق البحث والتصفية ليشمل البحث حسب الوحدة، المشروع، أو المطور.
    -   [ ] **تعديل Controllers**: تحديث `leads.controller.ts` و `deals.controller.ts`.
        -   [ ] تحديث مسارات API لتشمل `unitId`.
        -   [ ] تحديث `PermissionsGuard` ليشمل صلاحيات خاصة بالعملاء المحتملين والصفقات (مثال: `leads.assign`, `deals.approve`).
    -   [ ] **إنشاء Migrations**: إنشاء ملفات هجرة لتعديل جداول `leads` و `deals` وإضافة المفتاح الخارجي لـ `units`.
-   [ ] **الواجهة الأمامية (Frontend)**:
    -   [ ] **تعديل صفحات العملاء المحتملين والصفقات**: `Leads.tsx`, `Deals.tsx`, `DealsKanban.tsx`.
        -   [ ] إضافة حقل اختيار الوحدة (Dropdown) في نماذج إنشاء/تعديل العميل المحتمل والصفقة.
        -   [ ] عرض معلومات الوحدة، المشروع، والمطور المرتبطة بالعميل المحتمل/الصفقة.
        -   [ ] تحديث فلاتر البحث لتشمل البحث حسب الوحدة، المشروع، أو المطور.
        -   [ ] تطبيق صلاحيات الأزرار والحقول بناءً على صلاحيات `leads.create`, `leads.update`, `deals.create`, `deals.update`, `deals.approve`, `leads.assign`.

### المرحلة 6: تطبيق هيكل الأدوار والصلاحيات الجديد (Backend)

-   [ ] **تحديث نظام المصادقة (Authentication)**:
    -   [ ] التأكد من أن بيانات المستخدم (بما في ذلك الأدوار والصلاحيات) يتم تحميلها وتخزينها بشكل صحيح عند تسجيل الدخول (عادةً في JWT Payload).
-   [ ] **تطبيق PermissionsGuard على جميع Controllers**: مراجعة جميع الـ Controllers الحالية والجديدة وتطبيق `@UseGuards(PermissionsGuard)` عليها.
-   [ ] **تطبيق Decorators الصلاحيات على جميع المسارات (Routes)**:
    -   [ ] مراجعة كل مسار API في كل Controller وتحديد الصلاحيات المطلوبة له باستخدام `@Permissions("entity.action")`.
    -   [ ] **أمثلة**: 
        -   `@Permissions("users.read")` على `GET /users`.
        -   `@Permissions("companies.update")` على `PUT /companies/:id`.
        -   `@Permissions("developers.create")` على `POST /developers`.
        -   `@Permissions("projects.read")` على `GET /projects`.
        -   `@Permissions("units.delete")` على `DELETE /units/:id`.
        -   `@Permissions("leads.assign")` على مسار API لتعيين العملاء المحتملين.
        -   `@Permissions("deals.approve")` على مسار API للموافقة على الصفقات.
-   [ ] **تطبيق Row-Level Security في Services**: مراجعة جميع الـ Services والتأكد من أن جميع استعلامات قاعدة البيانات تتضمن تصفية `companyId`.
    -   [ ] بالنسبة لأدوار مثل `Sales Agent`، تطبيق تصفية إضافية (مثال: `where createdBy = userId` أو `where assignedTo = userId`) في الـ Services الخاصة بالعملاء المحتملين والصفقات والأنشطة.
-   [ ] **إنشاء/تحديث Seeders**: لملء قاعدة البيانات ببيانات الأدوار والصلاحيات الأولية.

### المرحلة 7: تطبيق هيكل الأدوار والصلاحيات الجديد (Frontend)

-   [ ] **إنشاء Context/Hook لإدارة الصلاحيات**: إنشاء `AuthContext` أو `usePermissions` Hook في `frontend/src/lib/` أو `frontend/src/hooks/`.
    -   [ ] هذا الـ Hook سيحتوي على منطق للتحقق مما إذا كان المستخدم الحالي لديه صلاحية معينة أو دور معين.
    -   [ ] يجب أن يعتمد على بيانات الأدوار والصلاحيات التي يتم جلبها من الواجهة الخلفية عند تسجيل الدخول.
-   [ ] **تطبيق الصلاحيات على عناصر UI**: مراجعة جميع الصفحات والمكونات في الواجهة الأمامية.
    -   [ ] **إخفاء/تعطيل الأزرار**: استخدام الـ Hook الجديد لإخفاء أو تعطيل الأزرار التي لا يمتلك المستخدم صلاحية النقر عليها (مثال: زر "إضافة مطور" إذا لم يكن لديه `developers.create`).
    -   [ ] **إخفاء/تعطيل حقول الإدخال**: إذا كان المستخدم لا يمتلك صلاحية التعديل على حقل معين، يجب تعطيله أو إخفاؤه.
    -   [ ] **إخفاء/تعطيل عناصر القائمة الجانبية (Sidebar)**: إخفاء الروابط لصفحات المطورين والمشاريع إذا لم يكن لدى المستخدم صلاحية الوصول إليها.
    -   [ ] **التوجيه الشرطي**: استخدام `react-router-dom` Guards أو منطق مشابه لإعادة توجيه المستخدمين إذا حاولوا الوصول إلى صفحة لا يمتلكون صلاحية الوصول إليها.

### المرحلة 8: تحديث التقارير والتحليلات

-   [ ] **الواجهة الخلفية (Backend)**:
    -   [ ] تعديل `analytics.service.ts` و `analytics.controller.ts`.
    -   [ ] إضافة APIs جديدة لتقارير المبيعات حسب المطور والمشروع.
    -   [ ] تحديث APIs التقارير الحالية لتشمل فلاتر حسب المطور والمشروع.
-   [ ] **الواجهة الأمامية (Frontend)**:
    -   [ ] تعديل صفحة `Analytics.tsx` و `AdvancedReports.tsx`.
    -   [ ] إضافة لوحات تحكم (Dashboards) ورسوم بيانية جديدة تعرض بيانات المبيعات حسب المطور والمشروع.
    -   [ ] إضافة فلاتر جديدة في صفحات التقارير للبحث حسب المطور والمشروع.

### المرحلة 9: التوثيق والاختبار

-   [ ] **التوثيق**: 
    -   [ ] تحديث وثائق API (Swagger/OpenAPI) لتعكس جميع المسارات الجديدة والمعدلة، مع تحديد الصلاحيات المطلوبة لكل مسار.
    -   [ ] تحديث ملف `README.md` للمشروع ليشمل معلومات عن الكيانات الجديدة وهيكل الأدوار والصلاحيات.
    -   [ ] إنشاء دليل مستخدم مفصل يوضح كيفية استخدام الميزات الجديدة وكيفية إدارة الأدوار والصلاحيات.
-   [ ] **الاختبار**: 
    -   [ ] **اختبار الوحدة (Unit Tests)**: كتابة اختبارات لجميع الخدمات والوحدات الجديدة والمعدلة.
    -   [ ] **اختبار التكامل (Integration Tests)**: اختبار تفاعل الوحدات المختلفة مع بعضها البعض، وخاصة تفاعل الكيانات الجديدة مع العملاء المحتملين والصفقات.
    -   [ ] **اختبار النهاية إلى النهاية (End-to-End Tests)**: اختبار سيناريوهات المستخدم الكاملة، مع التركيز على تدفقات العمل التي تتضمن الكيانات الجديدة وتطبيق الصلاحيات.
    -   [ ] **اختبار الأمان (Security Testing)**: التأكد من أن الصلاحيات يتم تطبيقها بشكل صحيح وأن هناك عزلًا كاملاً للبيانات بين الشركات.


