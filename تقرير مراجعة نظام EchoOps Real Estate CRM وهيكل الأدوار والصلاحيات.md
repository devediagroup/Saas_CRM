# تقرير مراجعة نظام EchoOps Real Estate CRM وهيكل الأدوار والصلاحيات

## 1. المقدمة

يهدف هذا التقرير إلى تقديم مراجعة شاملة لنظام EchoOps Real Estate CRM، مع التركيز بشكل خاص على دمج كيانات جديدة حيوية لسوق العقارات (المطورين والمشاريع) وإعادة بناء هيكل الأدوار والصلاحيات لضمان الأمان والكفاءة التشغيلية. يهدف التقرير إلى توضيح كيفية تأثير هذه الإضافات على وظائف النظام الحالية والمستقبلية، وتقديم هيكل صلاحيات مفصل يضمن أن كل مستخدم لديه الوصول المناسب فقط للمعلومات والوظائف التي يحتاجها لأداء مهامه.

تعتبر أنظمة إدارة علاقات العملاء (CRM) العمود الفقري لعمليات شركات التسويق العقاري الحديثة، حيث تمكنها من إدارة العملاء المحتملين، تتبع الصفقات، وتحليل الأداء. ومع ذلك، فإن تعقيد سوق العقارات، الذي يشمل أطرافًا متعددة مثل المطورين، شركات التسويق، والعملاء النهائيين، يتطلب نظامًا مرنًا وقويًا يمكنه استيعاب هذه العلاقات المعقدة. هذا التقرير سيتناول كيفية تحقيق ذلك من خلال التوسع المقترح في EchoOps Real Estate CRM.

سيتم تقسيم التقرير إلى عدة أقسام، تبدأ بمراجعة تفصيلية للصفحات والوظائف الحالية والمقترحة، ثم تنتقل إلى تقديم هيكل الأدوار والصلاحيات الجديد، وتختتم بآلية تطبيق هذه الصلاحيات والخلاصة والتوصيات النهائية.




## 2. مراجعة النظام الشاملة: الصفحات والوظائف

تمثل مراجعة النظام الشاملة خطوة أساسية لفهم البنية الحالية لـ EchoOps Real Estate CRM وتحديد نقاط التكامل اللازمة لإضافة كيانات المطورين والمشاريع. يهدف هذا القسم إلى تقديم نظرة عامة على الواجهتين الأمامية والخلفية للنظام، مع تسليط الضوء على كيفية تأثير الكيانات الجديدة على كل منهما.

### 2.1. الواجهة الأمامية (Frontend Pages)

تتكون الواجهة الأمامية لـ EchoOps Real Estate CRM من مجموعة من الصفحات المصممة لتوفير تجربة مستخدم سلسة لإدارة عمليات العقارات. الصفحات الحالية تغطي جوانب أساسية مثل إدارة العملاء المحتملين، الصفقات، العقارات، والتحليلات. فيما يلي مراجعة للصفحات الرئيسية والوظائف التي توفرها، بالإضافة إلى تصور للصفحات الجديدة والتعديلات المطلوبة:

#### 2.1.1. الصفحات الحالية والوظائف الأساسية:

*   **Dashboard (لوحة التحكم)**: توفر نظرة عامة سريعة على المقاييس الرئيسية مثل عدد العملاء المحتملين، الصفقات النشطة، وأداء المبيعات. تتضمن عادةً رسومًا بيانية وملخصات تنفيذية. [1]
*   **Leads (العملاء المحتملون)**: صفحة مخصصة لإدارة العملاء المحتملين، بما في ذلك عرض القائمة، إضافة عميل محتمل جديد، تعديل تفاصيله، وتتبع حالته عبر مراحل Pipeline. [2]
*   **Deals (الصفقات)**: تتيح إدارة الصفقات العقارية، من مرحلة الاهتمام الأولي وحتى إغلاق الصفقة. تتضمن تتبع مراحل الصفقة، ربطها بالعملاء المحتملين والعقارات، وحساب العمولات. [3]
*   **Properties (العقارات/الوحدات)**: صفحة لعرض وإدارة العقارات المتاحة للبيع أو الإيجار. تتضمن تفاصيل العقار، الصور، الموقع، السعر، والميزات. [4]
*   **Activities (الأنشطة)**: لإدارة وتتبع جميع التفاعلات مع العملاء، مثل المكالمات، الاجتماعات، والمهام المجدولة. [5]
*   **Analytics (التحليلات)**: توفر تقارير ورسومًا بيانية حول أداء المبيعات، التسويق، والعملاء، مما يساعد في اتخاذ قرارات مستنيرة. [6]
*   **Users (المستخدمون)**: لإدارة حسابات المستخدمين، بما في ذلك إضافة مستخدمين جدد، تعديل أدوارهم، وتعيين صلاحياتهم. [7]
*   **Companies (الشركات)**: لإدارة الشركات المستأجرة في النظام متعدد المستأجرين، بما في ذلك إعدادات الشركة وعزل البيانات. [8]
*   **Settings (الإعدادات)**: تحتوي على إعدادات النظام العامة وإعدادات خاصة بالشركة.
*   **AI Analysis & Recommendations**: صفحات لعرض التحليلات والتوصيات المدعومة بالذكاء الاصطناعي مثل Lead Scoring و Sales Forecasting. [9]
*   **Marketing Campaigns**: لإدارة حملات التسويق عبر البريد الإلكتروني أو WhatsApp. [10]
*   **Notifications**: لإدارة الإشعارات داخل النظام.
*   **Payments & Subscriptions**: لإدارة المدفوعات والاشتراكات إذا كان النظام يقدم كخدمة.
*   **Audit Logs**: لتتبع جميع الإجراءات التي تتم داخل النظام لأغراض التدقيق والأمان.

#### 2.1.2. تصور الصفحات الجديدة والتعديلات المطلوبة:

لدمج كيانات المطورين والمشاريع بشكل فعال، سيتطلب الأمر إضافة صفحات جديدة وتعديل الصفحات الحالية:

*   **Developers (المطورون)**: 
    *   **صفحة قائمة المطورين**: لعرض جميع المطورين المسجلين في النظام، مع إمكانية البحث، التصفية، والفرز. [11]
    *   **صفحة تفاصيل/إدارة المطور**: لإضافة مطور جديد، عرض تفاصيله (الاسم، معلومات الاتصال، الشعار، المشاريع المرتبطة)، وتعديل بياناته. [12]
*   **Projects (المشاريع)**: 
    *   **صفحة قائمة المشاريع**: لعرض جميع المشاريع العقارية، مع إمكانية البحث، التصفية (حسب المطور، الموقع، الحالة)، والفرز. [13]
    *   **صفحة تفاصيل/إدارة المشروع**: لإضافة مشروع جديد، عرض تفاصيله (الاسم، الوصف، الموقع، المطور المرتبط، الوحدات المرتبطة)، وتعديل بياناته. [14]
*   **Properties (الوحدات العقارية)**: 
    *   **تعديل صفحة إدارة الوحدات**: يجب تحديث هذه الصفحة لربط كل وحدة بمشروع معين. عند إضافة أو تعديل وحدة، يجب أن يكون هناك حقل لاختيار المشروع الذي تنتمي إليه الوحدة. [15]
    *   **تحديث فلاتر البحث**: إضافة فلاتر للبحث عن الوحدات حسب المشروع أو المطور. [16]
    *   **عرض معلومات المشروع والمطور**: في تفاصيل كل وحدة، يجب عرض معلومات المشروع والمطور المرتبطين بها.
*   **Leads & Deals (العملاء المحتملون والصفقات)**: 
    *   **ربط بالوحدات/المشاريع**: عند إنشاء عميل محتمل أو صفقة، يجب أن يكون هناك خيار لربطها بوحدة معينة، والتي بدورها ستكون مرتبطة بمشروع ومطور. هذا سيمكن من تتبع أداء المبيعات لكل مشروع ومطور. [17]
*   **Analytics & Reports (التحليلات والتقارير)**: 
    *   **تقارير جديدة**: إضافة تقارير تحليلية تركز على أداء المبيعات حسب المطور والمشروع (مثل: "أكثر المطورين تحقيقًا للمبيعات"، "أداء المشاريع الفردية"). [18]

### 2.2. الواجهة الخلفية (Backend Modules & APIs)

تعتمد الواجهة الخلفية على بنية NestJS، وتتكون من وحدات (Modules) منفصلة لكل كيان أو وظيفة رئيسية. هذه البنية تسهل إضافة وحدات جديدة وتعديل الوحدات الحالية. فيما يلي مراجعة للوحدات الحالية والـ APIs الخاصة بها، بالإضافة إلى تصور للوحدات الجديدة والتعديلات المطلوبة:

#### 2.2.1. الوحدات الحالية والـ APIs الأساسية:

*   **Auth (المصادقة)**: إدارة تسجيل الدخول، التسجيل، وإدارة الرموز المميزة (JWT). [19]
*   **Users (المستخدمون)**: إدارة بيانات المستخدمين، أدوارهم، وصلاحياتهم. [20]
*   **Companies (الشركات)**: إدارة الشركات المستأجرة وإعداداتها. [21]
*   **Leads (العملاء المحتملون)**: APIs لإنشاء، قراءة، تحديث، وحذف العملاء المحتملين، وتتبع مراحلهم. [22]
*   **Deals (الصفقات)**: APIs لإدارة الصفقات، بما في ذلك مراحلها، ربطها بالعملاء المحتملين والعقارات. [23]
*   **Properties (العقارات/الوحدات)**: APIs لإدارة العقارات، تفاصيلها، صورها، وحالتها. [24]
*   **Activities (الأنشطة)**: APIs لإدارة المكالمات، الاجتماعات، والمهام. [25]
*   **Analytics (التحليلات)**: APIs لتوفير البيانات للتقارير ولوحات التحكم. [26]
*   **Security (الأمان)**: تطبيق قواعد الأمان، مثل RBAC، و Audit Logs. [27]
*   **AI (الذكاء الاصطناعي)**: APIs لخدمات الذكاء الاصطناعي مثل Lead Scoring و Sales Forecasting. [28]
*   **WhatsApp & Email**: APIs لتكاملات التواصل. [29]
*   **Payments & Subscriptions**: APIs لإدارة المدفوعات والاشتراكات. [30]

#### 2.2.2. تصور الوحدات الجديدة والتعديلات المطلوبة:

*   **Developers (المطورون)**: 
    *   **وحدة `developers/` جديدة**: تتضمن Controller, Service, و Entity (نموذج قاعدة البيانات) لإدارة المطورين. [31]
    *   **APIs جديدة**: `POST /developers` (إنشاء)، `GET /developers` (قراءة)، `GET /developers/:id`، `PUT /developers/:id` (تحديث)، `DELETE /developers/:id` (حذف). [32]
*   **Projects (المشاريع)**: 
    *   **وحدة `projects/` جديدة**: تتضمن Controller, Service, و Entity لإدارة المشاريع. [33]
    *   **APIs جديدة**: `POST /projects` (إنشاء)، `GET /projects` (قراءة)، `GET /projects/:id`، `PUT /projects/:id` (تحديث)، `DELETE /projects/:id` (حذف). [34]
    *   **علاقة مع المطورين**: يجب أن يتضمن نموذج `Project` حقل `developerId` لربطه بالمطور، مع تطبيق قيود التكامل المرجعي في قاعدة البيانات. [35]
*   **Properties (الوحدات العقارية)**: 
    *   **تعديل وحدة `properties/`**: يجب تعديل نموذج `Property` (أو إعادة تسميته إلى `Unit`) ليشمل حقل `projectId` لربطه بالمشروع. [36]
    *   **تحديث الـ APIs**: تحديث APIs العقارات لتعكس هذا الربط، والسماح بالبحث والتصفية حسب المشروع والمطور. [37]
*   **Leads & Deals (العملاء المحتملون والصفقات)**: 
    *   **تعديل الوحدات**: تحديث نماذج `Lead` و `Deal` لربطها بالوحدات (وبالتالي بالمشاريع والمطورين) بشكل صريح أو ضمنيًا. [38]
    *   **تحديث الـ APIs**: السماح بربط العملاء المحتملين والصفقات بوحدات محددة. [39]
*   **Security (الأمان)**: 
    *   **تحديث حراس الصلاحيات (Guards)**: يجب تحديث منطق الصلاحيات في الواجهة الخلفية لضمان أن كل دور لديه الوصول الصحيح للكيانات الجديدة (المطورين والمشاريع) والكيانات المعدلة (الوحدات، العملاء المحتملون، الصفقات) بناءً على قواعد RBAC المحددة. [40]
    *   **تطبيق Row-Level Security**: التأكد من أن المستخدمين لا يمكنهم الوصول إلا إلى البيانات التي تنتمي إلى شركتهم، وحتى داخل الشركة، إلى البيانات التي يسمح لهم دورهم بالوصول إليها (مثل وكيل المبيعات الذي يرى فقط عملائه المحتملين وصفقاته). [41]

هذه المراجعة التفصيلية توضح حجم التغييرات المطلوبة لدمج الكيانات الجديدة وتأثيرها على جميع جوانب النظام، مما يمهد الطريق لإعادة بناء هيكل الأدوار والصلاحيات بشكل فعال.



## 3. هيكل الأدوار المقترح

بناءً على المراجعة الشاملة للنظام ودمج كيانات المطورين والمشاريع، نقترح هيكل أدوار معدلًا يضمن تغطية جميع الوظائف الجديدة والمعدلة، مع الحفاظ على مبدأ أقل الامتيازات (Principle of Least Privilege) وضمان عزل البيانات. هذا الهيكل مصمم ليتناسب مع الاحتياجات التشغيلية لشركات التسويق العقاري في بيئة متعددة المستأجرين.

الأدوار الأساسية المقترحة هي:

#### 3.1. Super Admin (المسؤول العام)

*   **الوصف**: هذا الدور هو الأعلى في التسلسل الهرمي للصلاحيات. يمتلك المسؤول العام تحكمًا كاملاً وشاملًا في جميع جوانب النظام، بما في ذلك إدارة البنية التحتية، إعدادات النظام العالمية، وإدارة جميع الشركات المستأجرة (Tenants) ومستخدميها. هذا الدور ضروري لإدارة النظام على مستوى المورد (Vendor-level) وليس على مستوى الشركة المستأجرة.
*   **المسؤوليات الرئيسية**: 
    *   إنشاء وإدارة حسابات الشركات المستأجرة.
    *   مراقبة أداء النظام وصحته.
    *   إدارة المستخدمين على مستوى النظام (بما في ذلك Super Admins آخرين).
    *   الوصول إلى جميع البيانات عبر جميع الشركات لأغراض التدقيق، الدعم الفني، أو التحليل الكلي.
    *   إدارة المطورين والمشاريع والوحدات على مستوى النظام (إذا كان هناك حاجة لإدارة مركزية).

#### 3.2. Company Admin (مسؤول الشركة)

*   **الوصف**: هو المسؤول الرئيسي عن إدارة نظام EchoOps CRM داخل شركته الخاصة. لديه صلاحيات إدارية كاملة على جميع البيانات والمستخدمين ضمن نطاق شركته فقط. لا يمكنه الوصول إلى بيانات أو إعدادات الشركات الأخرى.
*   **المسؤوليات الرئيسية**: 
    *   إدارة المستخدمين داخل شركته (إضافة، تعديل، حذف، تعيين أدوار).
    *   تخصيص إعدادات CRM الخاصة بشركته (مثل إعدادات التكامل، قوالب البريد الإلكتروني).
    *   إدارة المطورين والمشاريع والوحدات التي تتعامل معها شركته.
    *   مراقبة أداء فريقه وشركته من خلال التقارير والتحليلات الشاملة.
    *   الوصول إلى جميع العملاء المحتملين، الصفقات، والأنشطة الخاصة بشركته.

#### 3.3. Sales Manager (مدير المبيعات)

*   **الوصف**: يشرف على فريق من وكلاء المبيعات داخل شركته. يركز دوره على تحقيق أهداف المبيعات، مراقبة أداء الفريق، وتوجيه وكلاء المبيعات. لديه رؤية واسعة لعمليات المبيعات الخاصة بفريقه.
*   **المسؤوليات الرئيسية**: 
    *   مراقبة أداء وكلاء المبيعات التابعين له.
    *   توزيع العملاء المحتملين على فريقه.
    *   مراجعة والموافقة على الصفقات.
    *   الوصول إلى العملاء المحتملين، الصفقات، والأنشطة الخاصة بفريقه.
    *   عرض المطورين، المشاريع، والوحدات المتاحة.
    *   تحليل تقارير المبيعات الخاصة بفريقه.

#### 3.4. Sales Agent (وكيل المبيعات)

*   **الوصف**: هو المستخدم الأساسي الذي يتفاعل مباشرة مع العملاء المحتملين والصفقات. يركز دوره على توليد العملاء المحتملين، متابعتهم، إغلاق الصفقات، وإدارة الأنشطة اليومية المتعلقة بالمبيعات.
*   **المسؤوليات الرئيسية**: 
    *   إنشاء وتحديث العملاء المحتملين والصفقات الخاصة به.
    *   جدولة وتتبع الأنشطة (مكالمات، اجتماعات، مهام).
    *   عرض تفاصيل المطورين، المشاريع، والوحدات المتاحة.
    *   الوصول إلى التقارير الخاصة بأدائه الشخصي.
    *   الوصول إلى العملاء المحتملين والصفقات التي تم تعيينها له أو التي قام بإنشائها.

#### 3.5. Marketing (التسويق)

*   **الوصف**: مسؤول عن تخطيط وتنفيذ وتحليل الحملات التسويقية. يركز على جذب العملاء المحتملين وتغذيتهم، وتحليل فعالية قنوات التسويق.
*   **المسؤوليات الرئيسية**: 
    *   إنشاء وإدارة حملات التسويق (بريد إلكتروني، WhatsApp).
    *   الوصول إلى العملاء المحتملين (قراءة، إنشاء) لتحليل المصادر وتتبع الأداء.
    *   عرض المطورين، المشاريع، والوحدات لأغراض إنشاء المحتوى التسويقي.
    *   تحليل تقارير أداء التسويق ومصادر العملاء المحتملين.
    *   إدارة إعدادات التكاملات التسويقية.

#### 3.6. Support (الدعم)

*   **الوصف**: يقدم الدعم الفني والمساعدة للمستخدمين داخل الشركة. يركز على حل المشكلات، الإجابة على الاستفسارات، وضمان سلاسة استخدام النظام.
*   **المسؤوليات الرئيسية**: 
    *   الوصول للقراءة فقط لمعلومات المستخدمين، العملاء المحتملين، الصفقات، والأنشطة لأغراض الدعم.
    *   عرض تفاصيل المطورين، المشاريع، والوحدات للمساعدة في حل استفسارات العملاء.
    *   لا يمتلك صلاحيات تعديل على بيانات الأعمال الأساسية.

هذا الهيكل يوفر أساسًا متينًا لتحديد الصلاحيات بشكل دقيق، مما يضمن أن كل فرد في المنظمة يمكنه أداء مهامه بفعالية دون تجاوز نطاق صلاحياته.



## 4. مصفوفة الصلاحيات التفصيلية (Permissions Matrix)

توضح هذه المصفوفة الصلاحيات المحددة لكل دور على الكيانات المختلفة في نظام EchoOps Real Estate CRM. يتم تمثيل الصلاحيات باستخدام (C) للإنشاء (Create)، (R) للقراءة (Read)، (U) للتحديث (Update)، و (D) للحذف (Delete). بالإضافة إلى ذلك، سيتم الإشارة إلى الصلاحيات الخاصة مثل (A) للتعيين (Assign) أو (App) للموافقة (Approve).

**ملاحظات هامة على المصفوفة:**

*   **نطاق الصلاحية**: الصلاحيات المذكورة هي الحد الأقصى المسموح به للدور. يتم تطبيق "أقل الامتيازات"، مما يعني أن المستخدم قد لا يرى كل شيء حتى لو كان الدور يسمح بذلك، إذا كانت البيانات لا تنتمي إليه أو إلى فريقه (Row-Level Security).
*   **Multi-tenant**: صلاحيات Company Admin وما دونه تقتصر على نطاق الشركة الخاصة بهم. Super Admin هو الوحيد الذي يمكنه تجاوز هذا النطاق.
*   **CRUD**: تعني القدرة على أداء جميع العمليات الأساسية (إنشاء، قراءة، تحديث، حذف).

| الكيان / الميزة | Super Admin | Company Admin | Sales Manager | Sales Agent | Marketing | Support |
| :---------------- | :----------: | :------------: | :------------: | :----------: | :--------: | :-------: |
| **المستخدمون (Users)** | CRUD         | CRUD (داخل شركته) | R (فريقه)     | R (ملفه)     | R (ملفه)   | R (شركته) |
| **الشركات (Companies)** | CRUD         | R, U (شركته)    | -              | -            | -          | -         |
| **المطورون (Developers)** | CRUD         | CRUD (شركته)    | R              | R            | R          | R         |
| **المشاريع (Projects)** | CRUD         | CRUD (شركته)    | R              | R            | R          | R         |
| **الوحدات (Units)** | CRUD         | CRUD (شركته)    | R              | R            | R          | R         |
| **العملاء المحتملون (Leads)** | CRUD         | R (شركته)       | R, U, A (فريقه) | C, R, U (خاص به) | C, R, U (خاص به) | R (شركته) |
| **الصفقات (Deals)** | CRUD         | R (شركته)       | R, U, App (فريقه) | C, R, U (خاص به) | R          | R (شركته) |
| **الأنشطة (Activities)** | CRUD         | R (شركته)       | R (فريقه), C,U,D (خاص به) | C, R, U, D (خاص به) | R          | R (شركته) |
| **التقارير والتحليلات (Reports & Analytics)** | R (كامل)     | R (شركته)       | R (فريقه)     | R (خاص به)  | R          | -         |
| **الإعدادات (Settings)** | R, U (عام)  | R, U (شركته)    | -              | -            | R, U (تسويق) | -         |
| **AI Analysis** | R, U         | R, U (شركته)    | R              | R            | R          | -         |
| **Marketing Campaigns** | R, U         | R, U (شركته)    | -              | -            | C, R, U, D | -         |
| **Payments & Subscriptions** | R, U         | R, U (شركته)    | -              | -            | -          | -         |
| **Audit Logs** | R            | R (شركته)       | -              | -            | -          | -         |

**شرح إضافي لبعض الصلاحيات:**

*   **المستخدمون**: 
    *   `Super Admin`: يمكنه إدارة جميع المستخدمين في جميع الشركات.
    *   `Company Admin`: يمكنه إدارة المستخدمين داخل شركته فقط.
    *   `Sales Manager`: يمكنه قراءة معلومات المستخدمين في فريقه (وكلاء المبيعات التابعين له) لأغراض المراقبة والإدارة.
    *   `Sales Agent`, `Marketing`: يمكنهم فقط قراءة ملفهم الشخصي.
    *   `Support`: يمكنه قراءة معلومات جميع المستخدمين في شركته لأغراض الدعم الفني.

*   **العملاء المحتملون (Leads)**:
    *   `Sales Manager`: يمكنه قراءة وتحديث العملاء المحتملين في فريقه، بالإضافة إلى تعيين (Assign) العملاء المحتملين لوكلاء المبيعات في فريقه.
    *   `Sales Agent`: يمكنه إنشاء، قراءة، وتحديث العملاء المحتملين الذين تم تعيينهم له أو الذين قام بإنشائهم.
    *   `Marketing`: يمكنه إنشاء عملاء محتملين جدد (من الحملات التسويقية)، وقراءة وتحديث العملاء المحتملين الذين قام بإنشائهم.

*   **الصفقات (Deals)**:
    *   `Sales Manager`: يمكنه قراءة وتحديث الصفقات في فريقه، وقد يكون لديه صلاحية الموافقة (Approve) على صفقات معينة.
    *   `Sales Agent`: يمكنه إنشاء، قراءة، وتحديث الصفقات التي يديرها.

*   **التقارير والتحليلات (Reports & Analytics)**:
    *   `Super Admin`: وصول كامل لجميع التقارير على مستوى النظام.
    *   `Company Admin`: وصول كامل لجميع التقارير الخاصة بشركته.
    *   `Sales Manager`: وصول لتقارير أداء فريقه وتقارير المبيعات الخاصة بالشركة.
    *   `Sales Agent`: وصول لتقارير أدائه الشخصي.
    *   `Marketing`: وصول لتقارير أداء الحملات التسويقية ومصادر العملاء المحتملين.
    *   `Support`: لا يوجد وصول مباشر لتقارير الأعمال، ولكن قد يحتاج لتقارير أداء الدعم الفني (غير مدرجة هنا).

هذه المصفوفة توفر إطارًا واضحًا لتطبيق الصلاحيات في النظام، مما يضمن التحكم الدقيق في الوصول إلى البيانات والوظائف.



## 5. آلية تطبيق الصلاحيات

لتطبيق هيكل الأدوار والصلاحيات المقترح بفعالية في EchoOps Real Estate CRM، يجب اتباع نهج متعدد الطبقات يضمن الأمان والتحكم في الوصول على مستويي الواجهة الخلفية (Backend) والواجهة الأمامية (Frontend).

### 5.1. تطبيق الصلاحيات في الواجهة الخلفية (Backend Implementation)

تعتبر الواجهة الخلفية هي خط الدفاع الأول والأهم لتطبيق الصلاحيات، حيث يجب أن تفرض جميع قواعد الوصول قبل وصول البيانات إلى الواجهة الأمامية. يعتمد EchoOps CRM على NestJS، مما يوفر أدوات قوية لتطبيق RBAC.

#### 5.1.1. استخدام Guards (الحراس) و Decorators (المُزينات):

*   **Guards**: في NestJS، تُستخدم Guards لتحديد ما إذا كان يمكن للمستخدم الوصول إلى مسار (Route) معين بناءً على قواعد محددة. يمكن إنشاء Guard مخصص يتحقق من دور المستخدم وصلاحياته قبل السماح بالوصول إلى نقطة نهاية API.
*   **Decorators**: يمكن استخدام Decorators مخصصة (مثل `@Roles('admin', 'sales_manager')` أو `@Permissions('leads.read', 'deals.create')`) لتحديد الأدوار أو الصلاحيات المطلوبة لكل مسار API. سيقوم الـ Guard بقراءة هذه الـ Decorators والتحقق من أن المستخدم الحالي يمتلك الأدوار/الصلاحيات المطلوبة.

**مثال على تطبيق Guard:**

```typescript
// permissions.guard.ts
import { Injectable, CanActivate, ExecutionContext } from '@nestjs/common';
import { Reflector } from '@nestjs/core';

@Injectable()
export class PermissionsGuard implements CanActivate {
  constructor(private reflector: Reflector) {}

  canActivate(context: ExecutionContext): boolean {
    const requiredPermissions = this.reflector.get<string[]>('permissions', context.getHandler());
    if (!requiredPermissions) {
      return true; // No specific permissions required for this route
    }
    const request = context.switchToHttp().getRequest();
    const user = request.user; // Assuming user object is attached to request after authentication

    // Check if user has all required permissions
    return requiredPermissions.every(permission => user.permissions.includes(permission));
  }
}

// permissions.decorator.ts
import { SetMetadata } from '@nestjs/common';

export const Permissions = (...permissions: string[]) => SetMetadata('permissions', permissions);

// example.controller.ts
import { Controller, Get, UseGuards } from '@nestjs/common';
import { PermissionsGuard } from './permissions.guard';
import { Permissions } from './permissions.decorator';

@Controller('leads')
@UseGuards(PermissionsGuard)
export class LeadsController {
  @Get()
  @Permissions('leads.read')
  findAll() {
    // Logic to find all leads
  }

  @Post()
  @Permissions('leads.create')
  create(@Body() createLeadDto: CreateLeadDto) {
    // Logic to create a lead
  }
}
```

#### 5.1.2. Row-Level Security (أمان مستوى الصف):

بالإضافة إلى التحكم في الوصول على مستوى المسار (API endpoint)، من الضروري تطبيق أمان مستوى الصف لضمان أن المستخدمين لا يمكنهم الوصول إلا إلى البيانات التي يمتلكونها أو التي يسمح لهم دورهم بالوصول إليها ضمن نطاق شركتهم. يتم تحقيق ذلك عادةً في طبقة الخدمة (Service Layer) أو طبقة قاعدة البيانات.

*   **عزل البيانات بين الشركات (Multi-tenant Data Isolation)**: لكل استعلام قاعدة بيانات، يجب إضافة شرط `WHERE companyId = user.companyId` لضمان أن المستخدم يرى فقط البيانات الخاصة بشركته. هذا يتم تطبيقه بشكل عام في `Interceptor` أو `Middleware` أو في طبقة `Repository`.
*   **عزل البيانات داخل الشركة**: بالنسبة لأدوار مثل `Sales Agent`، يجب أن يتم تصفية البيانات بحيث يرى فقط العملاء المحتملين والصفقات التي تم تعيينها له أو التي قام بإنشائها. يمكن تحقيق ذلك عن طريق إضافة شروط `WHERE` إضافية في الاستعلامات (مثال: `WHERE assignedTo = user.id` أو `WHERE createdBy = user.id`).

#### 5.1.3. استخدام Interceptors (المُعترضات):

يمكن استخدام Interceptors في NestJS لتعديل الطلبات الواردة أو الاستجابات الصادرة. يمكن استخدامها لتطبيق منطق Multi-tenant Data Isolation تلقائيًا عن طريق حقن `companyId` في كل استعلام قاعدة بيانات.

### 5.2. تطبيق الصلاحيات في الواجهة الأمامية (Frontend Implementation)

بينما الواجهة الخلفية هي المسؤولة عن فرض الصلاحيات، فإن الواجهة الأمامية يجب أن تعكس هذه الصلاحيات لتحسين تجربة المستخدم ومنع عرض عناصر واجهة المستخدم التي لا يمكن للمستخدم التفاعل معها.

*   **إخفاء/تعطيل عناصر UI**: بناءً على الأدوار والصلاحيات التي يتم جلبها للمستخدم عند تسجيل الدخول، يمكن للواجهة الأمامية إخفاء الأزرار، الروابط، أو حقول الإدخال التي لا يمتلك المستخدم صلاحية الوصول إليها.
*   **التوجيه الشرطي (Conditional Routing)**: منع المستخدمين من الوصول إلى صفحات معينة إذا لم يكن لديهم الصلاحيات اللازمة، وإعادة توجيههم إلى صفحة "غير مصرح لك" (Unauthorized).
*   **مكونات الصلاحيات (Permission Components/Hooks)**: إنشاء مكونات React أو Hooks مخصصة تتحقق من صلاحيات المستخدم قبل عرض المحتوى. مثال:

```typescript
// usePermissions.ts (React Hook)
import { useAuth } from './auth.context'; // Assuming an auth context provides user roles/permissions

export const usePermissions = () => {
  const { user } = useAuth();

  const hasPermission = (permission: string) => {
    return user?.permissions?.includes(permission) || false;
  };

  const hasRole = (role: string) => {
    return user?.roles?.includes(role) || false;
  };

  return { hasPermission, hasRole };
};

// Example usage in a React component
import { Button } from '@/components/ui/button';
import { usePermissions } from './usePermissions';

const LeadsPage = () => {
  const { hasPermission } = usePermissions();

  return (
    <div>
      {hasPermission('leads.create') && (
        <Button>Add New Lead</Button>
      )}
      {/* ... rest of the page content */}
    </div>
  );
};
```

### 5.3. إدارة الأدوار والصلاحيات في قاعدة البيانات

*   **جداول الأدوار والصلاحيات**: يجب أن تكون الأدوار والصلاحيات قابلة للإدارة في قاعدة البيانات. يمكن أن يكون هناك جدول `roles` وجدول `permissions` وجدول ربط `role_permissions` وجدول `user_roles`.
*   **تحديث الصلاحيات ديناميكيًا**: يجب أن يسمح النظام للمسؤول العام (Super Admin) أو مسؤول الشركة (Company Admin) بتعديل الصلاحيات الممنوحة للأدوار المختلفة، ويجب أن تنعكس هذه التغييرات في النظام دون الحاجة إلى إعادة نشر الكود.

تطبيق هذه الآليات يضمن نظامًا قويًا وآمنًا لإدارة الصلاحيات، مما يوفر تجربة مستخدم متسقة وموثوقة.



## 6. الخلاصة والتوصيات النهائية

يمثل نظام EchoOps Real Estate CRM منصة قوية لإدارة علاقات العملاء في قطاع العقارات. المراجعة الشاملة التي تم إجراؤها لهذا التقرير، بالإضافة إلى دمج كيانات المطورين والمشاريع، تعزز بشكل كبير من قدرة النظام على تلبية الاحتياجات المعقدة لسوق التسويق العقاري في الوطن العربي.

### 6.1. الخلاصة

لقد أظهرت المراجعة أن EchoOps CRM يتمتع ببنية قوية ومرنة، سواء في الواجهة الأمامية (React) أو الواجهة الخلفية (NestJS). إضافة كيانات المطورين والمشاريع، وربط الوحدات العقارية بها، يمثل خطوة استراتيجية نحو توفير حل أكثر شمولية يعكس الواقع التشغيلي لشركات التسويق العقاري التي تعمل كوسيط بين المطورين والمشترين. هذا التوسع لا يضيف فقط وظائف جديدة، بل يثري أيضًا البيانات المتاحة للتحليل والتقارير، مما يمكن الشركات من اتخاذ قرارات أكثر استنارة.

إعادة بناء هيكل الأدوار والصلاحيات، مع التركيز على مبدأ RBAC وتطبيق أقل الامتيازات، يضمن أن النظام آمن وقابل للإدارة. تحديد الصلاحيات على مستوى كل كيان ووظيفة، وتوضيح كيفية تطبيقها في الواجهتين الخلفية والأمامية، يوفر خارطة طريق واضحة للتنفيذ ويقلل من مخاطر الوصول غير المصرح به للبيانات أو الوظائف.

### 6.2. التوصيات النهائية

بناءً على المراجعة والتحليل، نقدم التوصيات التالية لتعزيز وتطوير نظام EchoOps Real Estate CRM:

1.  **التنفيذ التدريجي للكيانات الجديدة**: البدء بتنفيذ كيانات المطورين والمشاريع بشكل تدريجي، مع التركيز على الواجهة الخلفية أولاً ثم الواجهة الأمامية. يجب التأكد من صحة العلاقات بين الكيانات الجديدة والقديمة (الوحدات، العملاء المحتملون، الصفقات).

2.  **التطبيق الصارم لـ Row-Level Security**: التأكد من أن جميع الاستعلامات في الواجهة الخلفية تفرض Row-Level Security لضمان أن المستخدمين لا يمكنهم الوصول إلا إلى البيانات التي يسمح لهم دورهم بالوصول إليها، وخاصة في بيئة Multi-tenant.

3.  **توسيع التقارير والتحليلات**: بعد دمج المطورين والمشاريع، يجب تطوير تقارير وتحليلات جديدة تستفيد من هذه البيانات الإضافية. على سبيل المثال، تقارير أداء المبيعات حسب المطور، أو حسب المشروع، أو مقارنة أداء المشاريع المختلفة.

4.  **تحسين تجربة المستخدم (UX) لإدارة الصلاحيات**: على الرغم من أن هيكل الصلاحيات قوي، يجب أن تكون واجهة المستخدم لإدارة الأدوار والصلاحيات سهلة الاستخدام لـ Company Admin، مما يسمح لهم بتعيين الأدوار وتعديل الصلاحيات (إذا كان ذلك مسموحًا) بكفاءة.

5.  **التوثيق الشامل**: توثيق جميع الـ APIs الجديدة والمعدلة، بالإضافة إلى توثيق مفصل لهيكل الأدوار والصلاحيات وآلية تطبيقها. هذا سيساعد المطورين الجدد على فهم النظام ويسهل الصيانة المستقبلية.

6.  **الاختبار الشامل**: إجراء اختبارات شاملة (Unit, Integration, End-to-End) لجميع الميزات الجديدة والمعدلة، وخاصة تلك المتعلقة بالصلاحيات وعزل البيانات، لضمان استقرار النظام وأمانه.

7.  **النظر في أدوار إضافية مستقبلية**: مع نمو النظام وتطور احتياجات العمل، قد تكون هناك حاجة لأدوار إضافية مثل "المحاسب" أو "مدير العقارات" (إذا كانت الشركة تدير عقاراتها الخاصة). يجب أن تكون البنية مرنة بما يكفي لاستيعاب هذه الأدوار.

من خلال اتباع هذه التوصيات، يمكن لـ EchoOps Real Estate CRM أن يصبح حلاً رائدًا وشاملًا لشركات التسويق العقاري، مما يمكنها من إدارة عملياتها بكفاءة أكبر وتحقيق أهدافها التجارية.

